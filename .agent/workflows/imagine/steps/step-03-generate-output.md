# Step 03: Generate Output Files

**Goal:** Create final prompt file and complete the creative pipeline.

**Scope:** File creation, pipeline completion.

**Token Budget:** ~350 tokens

---

## OUTPUT FILE CREATION

### File A: Imagen Prompts Markdown

**File path:** `{active_project_path}/05-imagine/imagine-prompts-{timestamp}.md`

**Content structure:**

```markdown
# Imagen Prompts: [Project Title]

## Generation Metadata

- **Art Style:** {selected style}
- **Total Prompts:** {count}
- **Generated:** {timestamp}
- **Source Pipeline:** Creative Studio v1.0

## Visual Consistency Guide

- **Color Palette:** {from visual_style_guide}
- **Lighting:** {from visual_style_guide}
- **Textures:** {from visual_style_guide}
- **Mood:** {from visual_style_guide}

## Character Consistency

| Character | Key Descriptors (use in every prompt) |
|-----------|--------------------------------------|
| Sarah | 38, dark hair pulled back, heavy wool coat, weathered but elegant |
| [Other] | [descriptors] |

---

## Prompts

### Prompt 1: [Frame Description]

**Chunk ID:** 1a
**Purpose:** Location establishment
**Aspect Ratio:** 16:9

**Prompt:**
```
[Full prompt text here - ready to copy/paste into Imagen]
```

**Negative Prompt:**
```
blurry, low quality, text, watermark, signature, oversaturated
```

**Technical Settings:**
- enhancePrompt: true
- aspectRatio: 16:9
- personGeneration: dont_allow
- safetySetting: block_medium_and_above

---

### Prompt 2: [Frame Description]

**Chunk ID:** 1c
**Purpose:** Emotional beat
**Aspect Ratio:** 3:4

**Prompt:**
```
[Full prompt text here]
```

**Negative Prompt:**
```
[Negative prompt]
```

**Technical Settings:**
- enhancePrompt: true
- aspectRatio: 3:4
- personGeneration: allow_adult
- safetySetting: block_medium_and_above

---

[Continue for all prompts...]

---

## Usage Instructions

### For Imagen 3 API:

```python
from google.cloud import aiplatform

response = model.generate_images(
    prompt="[copy prompt from above]",
    negative_prompt="[copy negative prompt]",
    number_of_images=4,
    aspect_ratio="16:9",
    safety_filter_level="block_medium_and_above",
    person_generation="dont_allow",
    add_watermark=False
)
```

### For Imagen 3 Web UI:

1. Copy prompt text
2. Paste into prompt field
3. Set aspect ratio as indicated
4. Generate and iterate

### Iteration Tips:

- If result is too busy: Add "minimalist, clean composition" to prompt
- If result is too dark: Add "well-lit, bright" to prompt
- If character is inconsistent: Use same exact character description each time
- For variations: Generate 4 at once, select best, iterate

---

## Pipeline Complete

This is the final stage of the Creative Studio pipeline:

1. ‚úÖ diverse-content-gen: Generated creative content
2. ‚úÖ storyteller: Transformed to visual scenes
3. ‚úÖ screenwriter: Formatted as screenplay
4. ‚úÖ production-validator: Validated for Veo 3
5. ‚úÖ imagine: Generated Imagen prompts

**Next steps:**
- Generate images using these prompts
- Use images as storyboard/reference for video production
- Pass to arch-v (if available) for video generation

---

*Generated by Imagine Workflow*
*Creative Studio Pipeline Complete*
```

### File B: Tracking Metadata (Optional)

**Note:** With per-project architecture, metadata can be embedded in the content file or stored separately as needed. The pipeline state in `pipeline-state.yaml` is the source of truth.

---

## UPDATE PIPELINE STATE

**CRITICAL:** Update BOTH the project-specific pipeline state AND the projects registry.

### Step C: Update Pipeline State

#### C1: Update Project Pipeline State

Use the **Edit** tool to update the per-project pipeline state file.

**Step 1:** Read projects registry to get active project path
**File:** `{project-root}/.bmad/creative-studio/_state/projects-registry.yaml`

**Step 2:** Edit the project's pipeline state file
**File:** `{active_project_path}/pipeline-state.yaml`

**Find this text (old_string):**
```yaml
current_stage: 4
last_updated: "{old_timestamp}"
```

**Replace with (new_string):**
```yaml
current_stage: 5
last_updated: "{timestamp}"
```

**THEN find this text (old_string):**
```yaml
  "05-imagine":
    status: "ready"
    outputs: []
    output_location: "/05-imagine/"
    input_from: "04-validator"
```

**Replace with (new_string):**
```yaml
  "05-imagine":
    status: "completed"
    completed_at: "{timestamp}"
    outputs: ["imagine-prompts-{timestamp}.md"]
    output_location: "/05-imagine/"
    input_from: "04-validator"
```

**THEN find this text (old_string):**
```yaml
  "06-arch-v":
    status: "pending"
    outputs: []
    output_location: "/06-arch-v/"
    input_from: "05-imagine"
```

**Replace with (new_string):**
```yaml
  "06-arch-v":
    status: "ready"
    outputs: []
    output_location: "/06-arch-v/"
    input_from: "05-imagine"
```

**THEN find this text (old_string):**
```yaml
# Quick Access
next_stage_ready: true
next_stage: "05-imagine"
last_output: "/04-validator/validated-{old_timestamp}.md"
```

**Replace with (new_string):**
```yaml
# Quick Access
next_stage_ready: true
next_stage: "06-arch-v"
last_output: "/05-imagine/imagine-prompts-{timestamp}.md"
```

#### C2: Update Projects Registry

Use the **Edit** tool to update the registry.

**File:** `{project-root}/.bmad/creative-studio/_state/projects-registry.yaml`

**Find the active project entry and update:**

**Find this text (old_string):**
```yaml
    current_stage: 4
    stages_completed: ["01-diverse", "02-storyteller", "03-screenwriter", "04-validator"]
```

**Replace with (new_string):**
```yaml
    current_stage: 5
    stages_completed: ["01-diverse", "02-storyteller", "03-screenwriter", "04-validator", "05-imagine"]
```

---

## PIPELINE COMPLETION SUMMARY

### Summary for User

```
üéâ CREATIVE STUDIO PIPELINE COMPLETE!

üìÑ Imagen Prompts: {file_path}
üé® Art Style: {style}
üñºÔ∏è Total Prompts: {count}

PIPELINE SUMMARY:
=================
1. ‚úÖ diverse-content-gen ‚Üí Generated {N} creative variations
2. ‚úÖ storyteller ‚Üí Created {N} visual scenes
3. ‚úÖ screenwriter ‚Üí Formatted screenplay with XML
4. ‚úÖ production-validator ‚Üí {N} chunks validated for Veo 3
5. ‚úÖ imagine ‚Üí {N} Imagen prompts ready

FILES CREATED:
- Content ideas: {diverse-content-gen output}
- Scene breakdown: {storyteller output}
- Screenplay: {screenwriter output}
- Validated screenplay: {validator output}
- Imagen prompts: {imagine output}

NEXT STEPS:
1. Generate images using the prompts file
2. Use images as storyboard for video production
3. Pass chunks to Veo 3 for video generation (if desired)

Would you like to:
1. View the Imagen prompts file
2. Start a new project in the pipeline
3. Export all files to output folder
4. Exit Creative Studio
```

---

## COMPLETION CHECKLIST

Before marking complete:

- [ ] Prompts file written with all key frames
- [ ] Each prompt has technical settings
- [ ] Tracking YAML created
- [ ] Pipeline state updated to "completed"
- [ ] Project added to history
- [ ] User presented with completion summary

---

**üéâ Creative Studio pipeline complete!**
